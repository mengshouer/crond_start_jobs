#!/system/bin/sh

scripts_dir="${0%/*}"
. "${scripts_dir}/utils.sh"

start_jobs_path="/data/adb/start_jobs"
backup_dir="$start_jobs_path/backup"

module_name="crond_start_jobs"
module_path=$(find /data/adb -type d -name "$module_name" | head -n 1)
PROPFILE="${module_path}/module.prop"

# è¿›ç¨‹æŸ¥æ‰¾å‡½æ•°
get_cron_pid() {
  local pid_file="$backup_dir/cron_pid"
  [[ -f "$pid_file" ]] && cat "$pid_file" || pgrep -f "crond -c ${cron_d_path}"
}

# å”¤é†’é”æŽ§åˆ¶å‡½æ•°
enable_wakelock() {
  if [[ ! -f "${backup_dir}/nowakelock" ]]; then
    echo "PowerManagerService.noSuspend.crond" >> /sys/power/wake_lock 2>/dev/null
    logd "å·²å¯ç”¨è®¾å¤‡å”¤é†’é”ï¼Œé˜²æ­¢ä»»åŠ¡åœ¨è®¾å¤‡ä¼‘çœ åŽæ— æ³•å‡†æ—¶æ‰§è¡Œ"
    logd "å¦‚éœ€å…³é—­å”¤é†’é”åŠŸèƒ½ï¼Œåœ¨ ${backup_dir} ä¸­æ–°å»ºä¸€ä¸ª nowakelock æ–‡ä»¶"
  fi
}

# é‡Šæ”¾å”¤é†’é”å‡½æ•°
disable_wakelock() {
  if grep -q "PowerManagerService.noSuspend.crond" /sys/power/wake_lock 2>/dev/null; then
    echo "PowerManagerService.noSuspend.crond" >> /sys/power/wake_unlock 2>/dev/null
  fi
}

# æ¨¡å—æè¿°æ›´æ–°å‡½æ•°
update_module_description() {
  local status="$1"
  sed -Ei "s/^description=(\[.*][[:space:]]*)?/description=[ $status ] /g" "$PROPFILE"
}

start_cron() {
  # ä¼˜åŒ–niceå‘½ä»¤æ£€æŸ¥
  local nice_cmd=""
  if command -v nice &> /dev/null; then
    nice_cmd="nice -n -10"
  fi
  
  # å¯åŠ¨crond
  $nice_cmd busybox crond -c $backup_dir
  sleep 2

  # èŽ·å–è¿›ç¨‹ID
  local cron_pid=$(get_cron_pid)
  
  logd_clear

  # æ£€æŸ¥ inotifyd åŠŸèƒ½ï¼ŒåŠŸèƒ½å¯åŠ¨åœ¨ start.sh
  if [[ ! -f "${backup_dir}/onlycrond" ]]; then
    logd "[ inotifyd å·²å¼€å¯ ]ï¼šå½“å‰å¯ä»¥ä½¿ç”¨ su ç®¡ç†å™¨æŽ§åˆ¶æ¨¡å—å¼€å…³ï¼Œä¸éœ€è¦é‡å¯æ‰‹æœº"
    logd "æ­¤åŠŸèƒ½æ˜¯ç”¨ inotifyd ç›‘æŽ§æ¨¡å—ç›®å½•å®žçŽ°çš„ï¼Œä¸ç»å¸¸å¼€å…³æ¨¡å—çš„å¯ä»¥å…³æŽ‰ï¼Œå¦‚æžœæ˜¯æœ‰æ“ä½œæŒ‰é’®çš„æ–°ç‰ˆ su ç®¡ç†å™¨ï¼Œå»ºè®®å…³é—­æ­¤é¡¹ï¼Œä½¿ç”¨æ“ä½œæŒ‰é’®æŽ§åˆ¶"
    logd "å¦‚éœ€å…³é—­æ­¤åŠŸèƒ½ï¼Œåœ¨ ${backup_dir} ä¸­æ–°å»ºä¸€ä¸ª onlycrond æ–‡ä»¶ï¼Œé‡å¯ç”Ÿæ•ˆ"
  fi

  if [[ -n $cron_pid ]]; then
    local crond_root_file=$backup_dir/root
    echo $cron_pid > $backup_dir/cron_pid
    # å¯ç”¨å”¤é†’é”
    enable_wakelock
    update_module_description "ðŸ˜ service (pid:$cron_pid) is running !!!"
    basic_Information
    logd "å¼€å§‹è¿è¡Œ: [$crond_root_file]"
    logd "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  else
    update_module_description "ðŸ˜± Module is working! but no service is running !!!"
    basic_Information
    logd "æœªæ£€æµ‹åˆ° cron ä»»åŠ¡ï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶åŽï¼Œæ‰‹åŠ¨è¿è¡Œä¸€é ${start_jobs_path}/Run_cron.sh"
    # å¦‚æžœå¯åŠ¨å¤±è´¥ï¼Œé‡Šæ”¾å”¤é†’é”
    disable_wakelock
    exit 1
  fi
}

stop_cron() {
  # èŽ·å–æ‰€æœ‰éœ€è¦åœæ­¢çš„è¿›ç¨‹ID
  local pids=$(get_cron_pid)
  
  # æ‰¹é‡åœæ­¢è¿›ç¨‹
  if [[ -n "$pids" ]]; then
    for pid in $pids; do
      kill -15 "$pid" 2>/dev/null
    done
  fi
  
  # é‡Šæ”¾å”¤é†’é”
  disable_wakelock
  
  # æ¸…ç†æ–‡ä»¶
  rm -f $backup_dir/cron_pid
  update_module_description "âŒ service is not running !!!"
}

case "$1" in
  start)
    stop_cron >> /dev/null 2>&1
    start_cron
    ;;
  stop)
    stop_cron
    ;;
  wakelock_on)
    enable_wakelock
    ;;
  wakelock_off)
    disable_wakelock
    ;;
esac
